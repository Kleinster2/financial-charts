<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chart Render</title>
    <script src="https://unpkg.com/lightweight-charts@5.0.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #ffffff; font-family: Arial, sans-serif; }
        #chart { width: 100%; height: 100vh; }
        .title {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 32px;
            font-weight: bold;
            color: #333;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            padding: 8px 14px;
            border-radius: 4px;
        }
        .watermark {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 11px;
            color: rgba(0,0,0,0.3);
            z-index: 100;
        }
        .legend {
            position: absolute;
            top: 62px;
            left: 20px;
            display: flex;
            gap: 24px;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            padding: 8px 14px;
            border-radius: 4px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 22px;
            font-weight: 600;
            color: #333;
        }
        .legend-color {
            width: 28px;
            height: 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="chart"></div>
    <div class="title" id="title"></div>
    <div class="legend" id="legend"></div>
    <div class="watermark">Financial Charts</div>

    <script>
        // Rebase data to percentage (100 = starting point, matching dashboard style)
        function rebaseData(rawData) {
            if (!rawData || rawData.length === 0) return [];
            const base = rawData[0].value;
            if (base === 0) return rawData;
            return rawData.map(pt => ({
                time: pt.time,
                value: (pt.value / base) * 100
            }));
        }

        // Format large numbers with K/M/B suffixes
        function formatLargeNumber(value) {
            const absValue = Math.abs(value);
            if (absValue >= 1e12) return (value / 1e12).toFixed(1) + 'T';
            if (absValue >= 1e9) return (value / 1e9).toFixed(1) + 'B';
            if (absValue >= 1e6) return (value / 1e6).toFixed(1) + 'M';
            if (absValue >= 1e3) return (value / 1e3).toFixed(1) + 'K';
            return value.toFixed(2);
        }

        // Chart configuration will be injected via window.CHART_CONFIG
        function renderChart(config) {
            const { data, title, width, height, showTitle, normalize, isFundamentals } = config;

            // Set title (hide if legend is sufficient: normalized multi-ticker or fundamentals)
            const titleEl = document.getElementById('title');
            const tickers = Object.keys(data);
            const hideTitle = (normalize && tickers.length > 1) || isFundamentals;
            if (showTitle && title && !hideTitle) {
                titleEl.textContent = title;
            } else {
                titleEl.style.display = 'none';
            }

            // Create chart
            const chartContainer = document.getElementById('chart');
            const chart = LightweightCharts.createChart(chartContainer, {
                width: width || 1200,
                height: height || 600,
                layout: {
                    background: { type: 'solid', color: '#ffffff' },
                    textColor: '#333',
                    fontSize: 20
                },
                grid: {
                    vertLines: { color: '#eee' },
                    horzLines: { color: '#eee' }
                },
                timeScale: {
                    secondsVisible: false,
                    rightOffset: 5,
                    borderColor: '#ccc'
                },
                rightPriceScale: {
                    visible: true,
                    borderColor: '#ccc',
                    scaleMargins: { top: 0.1, bottom: 0.1 },
                    mode: 1  // Logarithmic mode always
                },
                leftPriceScale: {
                    visible: false
                },
                crosshair: {
                    horzLine: { visible: false },
                    vertLine: { visible: false }
                }
            });

            // Color palette matching dashboard
            const colors = [
                '#2962FF', '#E91E63', '#4CAF50', '#FF9800',
                '#9C27B0', '#00BCD4', '#795548', '#607D8B'
            ];

            // Build legend (move up if no title)
            const legendEl = document.getElementById('legend');
            if (hideTitle) {
                legendEl.style.top = '15px';
            }

            // Add series for each ticker
            let colorIndex = 0;
            for (const [ticker, points] of Object.entries(data)) {
                const color = colors[colorIndex % colors.length];

                // Add legend item
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<div class="legend-color" style="background:${color}"></div><span>${ticker}</span>`;
                legendEl.appendChild(item);

                // Price formatter based on mode
                let priceFormat;
                if (normalize) {
                    priceFormat = {
                        type: 'custom',
                        minMove: 0.1,
                        formatter: (v) => {
                            const diff = v - 100;
                            const sign = diff > 0 ? '+' : diff < 0 ? '-' : '';
                            const dec = Math.abs(diff) >= 100 ? 0 : Math.abs(diff) >= 10 ? 1 : 2;
                            return `${sign}${Math.abs(diff).toFixed(dec)}%`;
                        }
                    };
                } else if (isFundamentals) {
                    priceFormat = {
                        type: 'custom',
                        minMove: 1,
                        formatter: formatLargeNumber
                    };
                } else {
                    priceFormat = { type: 'price', precision: 2, minMove: 0.01 };
                }

                const series = chart.addSeries(LightweightCharts.LineSeries, {
                    color: color,
                    lineWidth: 2,
                    lastValueVisible: false,
                    priceLineVisible: false,
                    crosshairMarkerVisible: false,
                    priceFormat: priceFormat
                });

                // Convert data format, apply rebasing if normalize=true
                const chartData = normalize ? rebaseData(points) : points.map(p => ({
                    time: p.time,
                    value: p.value
                }));

                series.setData(chartData);
                colorIndex++;
            }

            // Delay fitContent to ensure data is rendered
            setTimeout(() => {
                chart.timeScale().fitContent();
                // Signal ready for screenshot
                window.chartReady = true;
            }, 100);
        }

        // Wait for config to be injected
        if (window.CHART_CONFIG) {
            renderChart(window.CHART_CONFIG);
        }
    </script>
</body>
</html>
