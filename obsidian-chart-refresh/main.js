var d=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var v=(a,e)=>{for(var t in e)d(a,t,{get:e[t],enumerable:!0})},x=(a,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of k(e))!S.call(a,r)&&r!==t&&d(a,r,{get:()=>e[r],enumerable:!(s=b(e,r))||s.enumerable});return a};var U=a=>x(d({},"__esModule",{value:!0}),a);var F={};v(F,{default:()=>m});module.exports=U(F);var p=require("obsidian");function w(a){let e=a.replace(/\.png$/i,"");if(e.includes("-fundamentals")||e.includes("fundamentals"))return{type:"skip",reason:"fundamentals chart"};if(e.includes("-vs-"))return $(e);if(e.includes("-price-chart"))return B(e);let t=I(e);return t||{type:"unknown",filename:a}}function $(a){let e=a.match(/-(\d{4})$/),t=e?e[1]:null,s=t?a.replace(/-\d{4}$/,""):a,r=s.endsWith("-fx");r&&(s=s.replace(/-fx$/,""));let l=s.split("-vs-").map(o=>{let n=o.replace(/-price-chart$/,"").replace(/_/g,".").toUpperCase();return r&&(n=n+"=X"),n});if(l.length<2)return{type:"unknown",filename:a};for(let o of l)if(!/^[A-Z0-9.]{1,15}(=X)?$/.test(o))return{type:"unknown",filename:a};let c={tickers:l,normalize:!0,sortByLast:!0};return t&&(c.start=`${t}-01-01`),{type:"parsed",params:c}}function B(a){let e=a.match(/-(\d{4})$/),t=e?e[1]:null,s=a;if(t&&(s=s.replace(/-\d{4}$/,"")),s=s.replace(/-price-chart$/,"").replace(/_/g,".").toUpperCase(),!/^[A-Z0-9.]{1,15}$/.test(s))return{type:"unknown",filename:a};let r={tickers:[s],normalize:!1};return t&&(r.start=`${t}-01-01`),{type:"parsed",params:r}}function I(a){let e=a.match(/^(.+)-(\d+)(d|y)$/i);if(!e)return null;let[,t,s,r]=e,i=parseInt(s,10),l=t.replace(/_/g,".").toUpperCase();if(!/^[A-Z0-9.]{1,15}$/.test(l))return null;let c=new Date,o;r.toLowerCase()==="y"?o=i*365:o=i;let h=new Date(c.getTime()-o*24*60*60*1e3).toISOString().split("T")[0];return{type:"parsed",params:{tickers:[l],normalize:!1,start:h}}}function C(a,e){let t=new URL("/api/chart/lw",a);return t.searchParams.set("tickers",e.tickers.join(",")),e.normalize&&t.searchParams.set("normalize","true"),e.start&&t.searchParams.set("start",e.start),e.sortByLast&&t.searchParams.set("sort_by_last","true"),t.toString()}var y=require("obsidian");async function R(a){try{let e=await(0,y.requestUrl)({url:a,method:"GET"});return e.status!==200?(console.log(`Chart API returned status ${e.status}`),null):e.arrayBuffer}catch(e){return console.log(`Chart fetch failed (API not running?): ${e}`),null}}async function A(a,e,t,s){try{let r=`${s}/${e}`,i=a.getAbstractFileByPath(r);return i?await a.modifyBinary(i,t):await a.createBinary(r,t),!0}catch(r){return console.error(`Failed to write chart image: ${r}`),!1}}async function P(a){try{return(await(0,y.requestUrl)({url:a,method:"GET",throw:!1})).status<400}catch(e){return!1}}var u=require("obsidian"),T={apiBaseUrl:"http://localhost:5000",attachmentsFolder:"investing/attachments",autoRefresh:!0,cacheTtlMinutes:5},g=class extends u.PluginSettingTab{constructor(t,s){super(t,s);this.plugin=s}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Chart Refresh Settings"}),new u.Setting(t).setName("Auto-refresh on note open").setDesc("Automatically refresh price charts when a note is opened").addToggle(s=>s.setValue(this.plugin.settings.autoRefresh).onChange(async r=>{this.plugin.settings.autoRefresh=r,await this.plugin.saveSettings()})),new u.Setting(t).setName("API base URL").setDesc("Base URL for the chart API (default: http://localhost:5000)").addText(s=>s.setPlaceholder("http://localhost:5000").setValue(this.plugin.settings.apiBaseUrl).onChange(async r=>{this.plugin.settings.apiBaseUrl=r,await this.plugin.saveSettings()})),new u.Setting(t).setName("Attachments folder").setDesc("Folder path where chart images are stored").addText(s=>s.setPlaceholder("investing/attachments").setValue(this.plugin.settings.attachmentsFolder).onChange(async r=>{this.plugin.settings.attachmentsFolder=r,await this.plugin.saveSettings()})),new u.Setting(t).setName("Cache TTL (minutes)").setDesc("Skip refresh if image was updated less than this many minutes ago").addText(s=>s.setPlaceholder("5").setValue(String(this.plugin.settings.cacheTtlMinutes)).onChange(async r=>{let i=parseInt(r,10);!isNaN(i)&&i>=0&&(this.plugin.settings.cacheTtlMinutes=i,await this.plugin.saveSettings())}))}};var D=/!\[\[([^\]]+\.png)\]\]/gi,m=class extends p.Plugin{constructor(){super(...arguments);this.lastRefreshTimes=new Map;this.apiAvailable=null}async onload(){await this.loadSettings(),this.addSettingTab(new g(this.app,this)),this.registerEvent(this.app.workspace.on("file-open",async t=>{t&&this.settings.autoRefresh&&await this.refreshChartsInNote(t)})),this.addCommand({id:"refresh-charts-current-note",name:"Refresh charts in current note",callback:async()=>{let t=this.app.workspace.getActiveFile();t&&await this.refreshChartsInNote(t,!0)}}),console.log("Chart Refresh plugin loaded")}onunload(){console.log("Chart Refresh plugin unloaded")}async loadSettings(){this.settings=Object.assign({},T,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async refreshChartsInNote(t,s=!1){let i=[...(await this.app.vault.read(t)).matchAll(D)];if(i.length===0)return;let l=[...new Set(i.map(n=>n[1]))],c=[];for(let n of l){let h=w(n);if(h.type!=="skip"){if(h.type==="unknown"){console.log(`Unknown chart pattern: ${n}`);continue}if(h.type==="parsed"){if(!s&&!this.shouldRefresh(n))continue;let f=C(this.settings.apiBaseUrl,h.params);c.push({filename:n,apiUrl:f})}}}if(c.length===0)return;if((this.apiAvailable===null||this.apiAvailable===!1)&&(this.apiAvailable=await P(this.settings.apiBaseUrl)),!this.apiAvailable){s&&new p.Notice("Chart API not available");return}let o=0;for(let{filename:n,apiUrl:h}of c){let f=await R(h);f&&await A(this.app.vault,n,f,this.settings.attachmentsFolder)&&(this.lastRefreshTimes.set(n,Date.now()),o++)}s&&o>0&&new p.Notice(`Refreshed ${o} chart(s)`)}shouldRefresh(t){let s=this.lastRefreshTimes.get(t);if(!s)return!0;let r=this.settings.cacheTtlMinutes*60*1e3;return Date.now()-s>r}};
