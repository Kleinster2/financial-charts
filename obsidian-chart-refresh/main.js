var d=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var k=(s,t)=>{for(var e in t)d(s,e,{get:t[e],enumerable:!0})},U=(s,t,e,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of v(t))!S.call(s,r)&&r!==e&&d(s,r,{get:()=>t[r],enumerable:!(a=b(t,r))||a.enumerable});return s};var x=s=>U(d({},"__esModule",{value:!0}),s);var B={};k(B,{default:()=>g});module.exports=x(B);var c=require("obsidian");function y(s){let t=s.replace(/\.png$/i,"");return t.includes("-fundamentals")||t.includes("fundamentals")?{type:"skip",reason:"fundamentals chart"}:t.includes("-vs-")?$(t):t.includes("-price-chart")?I(t):{type:"unknown",filename:s}}function $(s){let t=s.match(/-(\d{4})$/),e=t?t[1]:null,n=(e?s.replace(/-\d{4}$/,""):s).split("-vs-").map(o=>o.replace(/-price-chart$/,"").toUpperCase());if(n.length<2)return{type:"unknown",filename:s};for(let o of n)if(!/^[A-Z0-9]{1,10}$/.test(o))return{type:"unknown",filename:s};let p={tickers:n,normalize:!0};return e&&(p.start=`${e}-01-01`),{type:"parsed",params:p}}function I(s){let t=s.match(/-(\d{4})$/),e=t?t[1]:null,a=s;if(e&&(a=a.replace(/-\d{4}$/,"")),a=a.replace(/-price-chart$/,"").toUpperCase(),!/^[A-Z0-9]{1,10}$/.test(a))return{type:"unknown",filename:s};let r={tickers:[a],normalize:!1};return e&&(r.start=`${e}-01-01`),{type:"parsed",params:r}}function C(s,t){let e=new URL("/api/chart/lw",s);return e.searchParams.set("tickers",t.tickers.join(",")),t.normalize&&e.searchParams.set("normalize","true"),t.start&&e.searchParams.set("start",t.start),e.toString()}var w=require("obsidian");async function A(s){try{let t=await(0,w.requestUrl)({url:s,method:"GET"});return t.status!==200?(console.log(`Chart API returned status ${t.status}`),null):t.arrayBuffer}catch(t){return console.log(`Chart fetch failed (API not running?): ${t}`),null}}async function R(s,t,e,a){try{let r=`${a}/${t}`,n=s.getAbstractFileByPath(r);return n?await s.modifyBinary(n,e):await s.createBinary(r,e),!0}catch(r){return console.error(`Failed to write chart image: ${r}`),!1}}async function P(s){try{return(await(0,w.requestUrl)({url:s,method:"GET",throw:!1})).status===200}catch(t){return!1}}var l=require("obsidian"),T={apiBaseUrl:"http://localhost:5000",attachmentsFolder:"investing/attachments",autoRefresh:!0,cacheTtlMinutes:5},f=class extends l.PluginSettingTab{constructor(e,a){super(e,a);this.plugin=a}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Chart Refresh Settings"}),new l.Setting(e).setName("Auto-refresh on note open").setDesc("Automatically refresh price charts when a note is opened").addToggle(a=>a.setValue(this.plugin.settings.autoRefresh).onChange(async r=>{this.plugin.settings.autoRefresh=r,await this.plugin.saveSettings()})),new l.Setting(e).setName("API base URL").setDesc("Base URL for the chart API (default: http://localhost:5000)").addText(a=>a.setPlaceholder("http://localhost:5000").setValue(this.plugin.settings.apiBaseUrl).onChange(async r=>{this.plugin.settings.apiBaseUrl=r,await this.plugin.saveSettings()})),new l.Setting(e).setName("Attachments folder").setDesc("Folder path where chart images are stored").addText(a=>a.setPlaceholder("investing/attachments").setValue(this.plugin.settings.attachmentsFolder).onChange(async r=>{this.plugin.settings.attachmentsFolder=r,await this.plugin.saveSettings()})),new l.Setting(e).setName("Cache TTL (minutes)").setDesc("Skip refresh if image was updated less than this many minutes ago").addText(a=>a.setPlaceholder("5").setValue(String(this.plugin.settings.cacheTtlMinutes)).onChange(async r=>{let n=parseInt(r,10);!isNaN(n)&&n>=0&&(this.plugin.settings.cacheTtlMinutes=n,await this.plugin.saveSettings())}))}};var F=/!\[\[([^\]]+\.png)\]\]/gi,g=class extends c.Plugin{constructor(){super(...arguments);this.lastRefreshTimes=new Map;this.apiAvailable=null}async onload(){await this.loadSettings(),this.addSettingTab(new f(this.app,this)),this.registerEvent(this.app.workspace.on("file-open",async e=>{e&&this.settings.autoRefresh&&await this.refreshChartsInNote(e)})),this.addCommand({id:"refresh-charts-current-note",name:"Refresh charts in current note",callback:async()=>{let e=this.app.workspace.getActiveFile();e&&await this.refreshChartsInNote(e,!0)}}),console.log("Chart Refresh plugin loaded")}onunload(){console.log("Chart Refresh plugin unloaded")}async loadSettings(){this.settings=Object.assign({},T,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async refreshChartsInNote(e,a=!1){let n=[...(await this.app.vault.read(e)).matchAll(F)];if(n.length===0)return;let p=[...new Set(n.map(i=>i[1]))],o=[];for(let i of p){let h=y(i);if(h.type!=="skip"){if(h.type==="unknown"){console.log(`Unknown chart pattern: ${i}`);continue}if(h.type==="parsed"){if(!a&&!this.shouldRefresh(i))continue;let u=C(this.settings.apiBaseUrl,h.params);o.push({filename:i,apiUrl:u})}}}if(o.length===0)return;if((this.apiAvailable===null||this.apiAvailable===!1)&&(this.apiAvailable=await P(this.settings.apiBaseUrl)),!this.apiAvailable){a&&new c.Notice("Chart API not available");return}let m=0;for(let{filename:i,apiUrl:h}of o){let u=await A(h);u&&await R(this.app.vault,i,u,this.settings.attachmentsFolder)&&(this.lastRefreshTimes.set(i,Date.now()),m++)}a&&m>0&&new c.Notice(`Refreshed ${m} chart(s)`)}shouldRefresh(e){let a=this.lastRefreshTimes.get(e);if(!a)return!0;let r=this.settings.cacheTtlMinutes*60*1e3;return Date.now()-a>r}};
