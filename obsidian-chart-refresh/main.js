var R=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var M=(s,e)=>{for(var t in e)R(s,t,{get:e[t],enumerable:!0})},B=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of $(e))!U.call(s,a)&&a!==t&&R(s,a,{get:()=>e[a],enumerable:!(r=E(e,a))||r.enumerable});return s};var I=s=>B(R({},"__esModule",{value:!0}),s);var _={};M(_,{default:()=>w});module.exports=I(_);var g=require("obsidian");function P(s){let e=s.replace(/\.png$/i,"");if(e.includes("-fundamentals")||e.includes("fundamentals"))return{type:"skip",reason:"fundamentals chart"};if(e.includes("-vs-"))return D(e);if(e.includes("-price-chart"))return F(e);let t=z(e);return t||{type:"unknown",filename:s}}function D(s){let e=s.match(/-(\d{4})$/),t=e?e[1]:null,r=t?s.replace(/-\d{4}$/,""):s,a=r.endsWith("-fx");a&&(r=r.replace(/-fx$/,""));let u=r.split("-vs-").map(o=>{let h=o.replace(/-price-chart$/,"").replace(/_/g,".").toUpperCase();return a&&(h=h+"=X"),h});if(u.length<2)return{type:"unknown",filename:s};for(let o of u)if(!/^[A-Z0-9.]{1,15}(=X)?$/.test(o))return{type:"unknown",filename:s};let c={tickers:u,normalize:!0,sortByLast:!0};return t&&(c.start=`${t}-01-01`),{type:"parsed",params:c}}function F(s){let e=s.match(/-(\d{4})$/),t=e?e[1]:null,r=s;if(t&&(r=r.replace(/-\d{4}$/,"")),r=r.replace(/-price-chart$/,"").replace(/_/g,".").toUpperCase(),!/^[A-Z0-9.]{1,15}$/.test(r))return{type:"unknown",filename:s};let a={tickers:[r],normalize:!1};return t&&(a.start=`${t}-01-01`),{type:"parsed",params:a}}function z(s){let e=s.match(/^(.+)-(\d+)(d|y)$/i);if(!e)return null;let[,t,r,a]=e,i=parseInt(r,10),u=t.replace(/_/g,".").toUpperCase();if(!/^[A-Z0-9.]{1,15}$/.test(u))return null;let c=new Date,o;a.toLowerCase()==="y"?o=i*365:o=i;let n=new Date(c.getTime()-o*24*60*60*1e3).toISOString().split("T")[0];return{type:"parsed",params:{tickers:[u],normalize:!1,start:n}}}function T(s){let e=new Map,t=s.match(/^---\n([\s\S]*?)\n---/);if(!t)return e;let a=t[1].match(/charts:\n([\s\S]*?)(?=\n[^\s]|$)/);if(!a)return e;let i=a[1],u=/^\s{2}([^\s:]+\.png):\n((?:\s{4}[^\n]+\n?)*)/gm,c;for(;(c=u.exec(i))!==null;){let o=c[1],h=c[2],n={},l=h.match(/tickers:\s*([^\n]+)/);l&&(n.tickers=l[1].trim());let p=h.match(/normalize:\s*(true|false)/);p&&(n.normalize=p[1]==="true");let m=h.match(/start:\s*([^\n]+)/);m&&(n.start=m[1].trim());let y=h.match(/skip:\s*(true|false)/);y&&(n.skip=y[1]==="true"),e.set(o,n)}return e}function A(s){var e;return s.skip||!s.tickers?null:{tickers:s.tickers.split(",").map(t=>t.trim()),normalize:(e=s.normalize)!=null?e:!1,start:s.start}}function C(s,e){let t=new URL("/api/chart/lw",s);return t.searchParams.set("tickers",e.tickers.join(",")),e.normalize&&t.searchParams.set("normalize","true"),e.start&&t.searchParams.set("start",e.start),e.sortByLast&&t.searchParams.set("sort_by_last","true"),t.toString()}var k=require("obsidian");async function S(s){try{let e=await(0,k.requestUrl)({url:s,method:"GET"});return e.status!==200?(console.log(`Chart API returned status ${e.status}`),null):e.arrayBuffer}catch(e){return console.log(`Chart fetch failed (API not running?): ${e}`),null}}async function b(s,e,t,r){try{let a=`${r}/${e}`,i=s.getAbstractFileByPath(a);return i?await s.modifyBinary(i,t):await s.createBinary(a,t),!0}catch(a){return console.error(`Failed to write chart image: ${a}`),!1}}async function v(s){try{return(await(0,k.requestUrl)({url:s,method:"GET",throw:!1})).status<400}catch(e){return!1}}var f=require("obsidian"),x={apiBaseUrl:"http://localhost:5000",attachmentsFolder:"investing/attachments",autoRefresh:!0,cacheTtlMinutes:5},d=class extends f.PluginSettingTab{constructor(t,r){super(t,r);this.plugin=r}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Chart Refresh Settings"}),new f.Setting(t).setName("Auto-refresh on note open").setDesc("Automatically refresh price charts when a note is opened").addToggle(r=>r.setValue(this.plugin.settings.autoRefresh).onChange(async a=>{this.plugin.settings.autoRefresh=a,await this.plugin.saveSettings()})),new f.Setting(t).setName("API base URL").setDesc("Base URL for the chart API (default: http://localhost:5000)").addText(r=>r.setPlaceholder("http://localhost:5000").setValue(this.plugin.settings.apiBaseUrl).onChange(async a=>{this.plugin.settings.apiBaseUrl=a,await this.plugin.saveSettings()})),new f.Setting(t).setName("Attachments folder").setDesc("Folder path where chart images are stored").addText(r=>r.setPlaceholder("investing/attachments").setValue(this.plugin.settings.attachmentsFolder).onChange(async a=>{this.plugin.settings.attachmentsFolder=a,await this.plugin.saveSettings()})),new f.Setting(t).setName("Cache TTL (minutes)").setDesc("Skip refresh if image was updated less than this many minutes ago").addText(r=>r.setPlaceholder("5").setValue(String(this.plugin.settings.cacheTtlMinutes)).onChange(async a=>{let i=parseInt(a,10);!isNaN(i)&&i>=0&&(this.plugin.settings.cacheTtlMinutes=i,await this.plugin.saveSettings())}))}};var L=/!\[\[([^\]]+\.png)\]\]/gi,N="chart-registry.md",w=class extends g.Plugin{constructor(){super(...arguments);this.lastRefreshTimes=new Map;this.apiAvailable=null;this.registry=new Map}async onload(){await this.loadSettings(),await this.loadRegistry(),this.addSettingTab(new d(this.app,this)),this.registerEvent(this.app.workspace.on("file-open",async t=>{t&&this.settings.autoRefresh&&await this.refreshChartsInNote(t)})),this.addCommand({id:"refresh-charts-current-note",name:"Refresh charts in current note",callback:async()=>{let t=this.app.workspace.getActiveFile();t&&await this.refreshChartsInNote(t,!0)}}),this.addCommand({id:"reload-chart-registry",name:"Reload chart registry",callback:async()=>{await this.loadRegistry(),new g.Notice(`Loaded ${this.registry.size} chart(s) from registry`)}}),console.log("Chart Refresh plugin loaded")}async loadRegistry(){try{let t=this.app.vault.getAbstractFileByPath(N);if(t&&t instanceof g.TFile){let r=await this.app.vault.read(t);this.registry=T(r),console.log(`Loaded ${this.registry.size} chart(s) from registry`)}}catch(t){console.log(`Could not load chart registry: ${t}`)}}onunload(){console.log("Chart Refresh plugin unloaded")}async loadSettings(){this.settings=Object.assign({},x,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async refreshChartsInNote(t,r=!1){var h;let i=[...(await this.app.vault.read(t)).matchAll(L)];if(i.length===0)return;let u=[...new Set(i.map(n=>n[1]))],c=[];for(let n of u){let l=P(n);if(l.type!=="skip"){if(l.type==="unknown"){let p=this.registry.get(n);if(p){if(p.skip)continue;let m=A(p);if(m){if(!r&&!this.shouldRefresh(n))continue;let y=C(this.settings.apiBaseUrl,m);c.push({filename:n,apiUrl:y})}}else console.log(`Unknown chart pattern (not in registry): ${n}`);continue}if(l.type==="parsed"){if(!r&&!this.shouldRefresh(n))continue;let p=C(this.settings.apiBaseUrl,l.params);c.push({filename:n,apiUrl:p})}}}if(c.length===0)return;if((this.apiAvailable===null||this.apiAvailable===!1)&&(this.apiAvailable=await v(this.settings.apiBaseUrl)),!this.apiAvailable){r&&new g.Notice("Chart API not available");return}let o=0;for(let{filename:n,apiUrl:l}of c){let p=await S(l);p&&await b(this.app.vault,n,p,this.settings.attachmentsFolder)&&(this.lastRefreshTimes.set(n,Date.now()),o++)}if(o>0){await new Promise(l=>setTimeout(l,100));let n=this.app.workspace.activeLeaf;if(((h=n==null?void 0:n.view)==null?void 0:h.getViewType())==="markdown"){let l=n.view.getState();await n.view.setState(l,{history:!1})}}r&&o>0&&new g.Notice(`Refreshed ${o} chart(s)`)}shouldRefresh(t){let r=this.lastRefreshTimes.get(t);if(!r)return!0;let a=this.settings.cacheTtlMinutes*60*1e3;return Date.now()-r>a}};
