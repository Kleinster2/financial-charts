var d=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var k=(a,t)=>{for(var e in t)d(a,e,{get:t[e],enumerable:!0})},x=(a,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of v(t))!S.call(a,r)&&r!==e&&d(a,r,{get:()=>t[r],enumerable:!(s=b(t,r))||s.enumerable});return a};var U=a=>x(d({},"__esModule",{value:!0}),a);var I={};k(I,{default:()=>m});module.exports=U(I);var u=require("obsidian");function w(a){let t=a.replace(/\.png$/i,"");return t.includes("-fundamentals")||t.includes("fundamentals")?{type:"skip",reason:"fundamentals chart"}:t.includes("-vs-")?$(t):t.includes("-price-chart")?B(t):{type:"unknown",filename:a}}function $(a){let t=a.match(/-(\d{4})$/),e=t?t[1]:null,s=e?a.replace(/-\d{4}$/,""):a,r=s.endsWith("-fx");r&&(s=s.replace(/-fx$/,""));let p=s.split("-vs-").map(o=>{let n=o.replace(/-price-chart$/,"").replace(/_/g,".").toUpperCase();return r&&(n=n+"=X"),n});if(p.length<2)return{type:"unknown",filename:a};for(let o of p)if(!/^[A-Z0-9.]{1,15}(=X)?$/.test(o))return{type:"unknown",filename:a};let h={tickers:p,normalize:!0,sortByLast:!0};return e&&(h.start=`${e}-01-01`),{type:"parsed",params:h}}function B(a){let t=a.match(/-(\d{4})$/),e=t?t[1]:null,s=a;if(e&&(s=s.replace(/-\d{4}$/,"")),s=s.replace(/-price-chart$/,"").replace(/_/g,".").toUpperCase(),!/^[A-Z0-9.]{1,15}$/.test(s))return{type:"unknown",filename:a};let r={tickers:[s],normalize:!1};return e&&(r.start=`${e}-01-01`),{type:"parsed",params:r}}function C(a,t){let e=new URL("/api/chart/lw",a);return e.searchParams.set("tickers",t.tickers.join(",")),t.normalize&&e.searchParams.set("normalize","true"),t.start&&e.searchParams.set("start",t.start),t.sortByLast&&e.searchParams.set("sort_by_last","true"),e.toString()}var y=require("obsidian");async function A(a){try{let t=await(0,y.requestUrl)({url:a,method:"GET"});return t.status!==200?(console.log(`Chart API returned status ${t.status}`),null):t.arrayBuffer}catch(t){return console.log(`Chart fetch failed (API not running?): ${t}`),null}}async function R(a,t,e,s){try{let r=`${s}/${t}`,i=a.getAbstractFileByPath(r);return i?await a.modifyBinary(i,e):await a.createBinary(r,e),!0}catch(r){return console.error(`Failed to write chart image: ${r}`),!1}}async function P(a){try{return(await(0,y.requestUrl)({url:a,method:"GET",throw:!1})).status<400}catch(t){return!1}}var l=require("obsidian"),T={apiBaseUrl:"http://localhost:5000",attachmentsFolder:"investing/attachments",autoRefresh:!0,cacheTtlMinutes:5},g=class extends l.PluginSettingTab{constructor(e,s){super(e,s);this.plugin=s}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Chart Refresh Settings"}),new l.Setting(e).setName("Auto-refresh on note open").setDesc("Automatically refresh price charts when a note is opened").addToggle(s=>s.setValue(this.plugin.settings.autoRefresh).onChange(async r=>{this.plugin.settings.autoRefresh=r,await this.plugin.saveSettings()})),new l.Setting(e).setName("API base URL").setDesc("Base URL for the chart API (default: http://localhost:5000)").addText(s=>s.setPlaceholder("http://localhost:5000").setValue(this.plugin.settings.apiBaseUrl).onChange(async r=>{this.plugin.settings.apiBaseUrl=r,await this.plugin.saveSettings()})),new l.Setting(e).setName("Attachments folder").setDesc("Folder path where chart images are stored").addText(s=>s.setPlaceholder("investing/attachments").setValue(this.plugin.settings.attachmentsFolder).onChange(async r=>{this.plugin.settings.attachmentsFolder=r,await this.plugin.saveSettings()})),new l.Setting(e).setName("Cache TTL (minutes)").setDesc("Skip refresh if image was updated less than this many minutes ago").addText(s=>s.setPlaceholder("5").setValue(String(this.plugin.settings.cacheTtlMinutes)).onChange(async r=>{let i=parseInt(r,10);!isNaN(i)&&i>=0&&(this.plugin.settings.cacheTtlMinutes=i,await this.plugin.saveSettings())}))}};var F=/!\[\[([^\]]+\.png)\]\]/gi,m=class extends u.Plugin{constructor(){super(...arguments);this.lastRefreshTimes=new Map;this.apiAvailable=null}async onload(){await this.loadSettings(),this.addSettingTab(new g(this.app,this)),this.registerEvent(this.app.workspace.on("file-open",async e=>{e&&this.settings.autoRefresh&&await this.refreshChartsInNote(e)})),this.addCommand({id:"refresh-charts-current-note",name:"Refresh charts in current note",callback:async()=>{let e=this.app.workspace.getActiveFile();e&&await this.refreshChartsInNote(e,!0)}}),console.log("Chart Refresh plugin loaded")}onunload(){console.log("Chart Refresh plugin unloaded")}async loadSettings(){this.settings=Object.assign({},T,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async refreshChartsInNote(e,s=!1){let i=[...(await this.app.vault.read(e)).matchAll(F)];if(i.length===0)return;let p=[...new Set(i.map(n=>n[1]))],h=[];for(let n of p){let c=w(n);if(c.type!=="skip"){if(c.type==="unknown"){console.log(`Unknown chart pattern: ${n}`);continue}if(c.type==="parsed"){if(!s&&!this.shouldRefresh(n))continue;let f=C(this.settings.apiBaseUrl,c.params);h.push({filename:n,apiUrl:f})}}}if(h.length===0)return;if((this.apiAvailable===null||this.apiAvailable===!1)&&(this.apiAvailable=await P(this.settings.apiBaseUrl)),!this.apiAvailable){s&&new u.Notice("Chart API not available");return}let o=0;for(let{filename:n,apiUrl:c}of h){let f=await A(c);f&&await R(this.app.vault,n,f,this.settings.attachmentsFolder)&&(this.lastRefreshTimes.set(n,Date.now()),o++)}s&&o>0&&new u.Notice(`Refreshed ${o} chart(s)`)}shouldRefresh(e){let s=this.lastRefreshTimes.get(e);if(!s)return!0;let r=this.settings.cacheTtlMinutes*60*1e3;return Date.now()-s>r}};
