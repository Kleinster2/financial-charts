<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Charting Sandbox (Lightweight Charts vLatest)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:1rem;background:#fafafa;}
    #controls{margin-bottom:1rem;}
    #chart{width:100%;height:600px;border:1px solid #ccc;background:#fff;}
    input[type=text]{width:300px;padding:4px;font-size:1rem;}
    button{padding:4px 10px;margin-left:6px;font-size:1rem;}
  </style>
  <!-- Latest Lightweight Charts build -->
  <script src="https://unpkg.com/lightweight-charts@5.0.8/dist/lightweight-charts.standalone.development.js"></script>
</head>
<body>
  <h2>Lightweight Charts Sandbox</h2>
  <div id="controls">
    <label>
      Tickers (comma-separated):
      <input id="tickers-input" type="text" value="SPY">
    </label>
    <button id="plot-btn">Plot</button>
  </div>
  <div id="chart"></div>

  <script>
    const chartContainer = document.getElementById('chart');
    // --- Chart Setup ---
    const chart = LightweightCharts.createChart(chartContainer, {
      layout: { background: { type: 'solid', color: '#ffffff' }, textColor: '#333' },
      grid: { vertLines: { color: '#eee' }, horzLines: { color: '#eee' } },
      timeScale: { secondsVisible: false, rightOffset: 10, fixLeftEdge: true },
      rightPriceScale: { visible: true, scaleMargins: { top: 0.1, bottom: 0.1 } },
      // Create a second price scale for the bottom pane
      leftPriceScale: { visible: true, scaleMargins: { top: 0.1, bottom: 0.1 } }, 
    });

    // Create two panes. The top pane (pane 0) is created by default.
    // The bottom pane (pane 1) will be for the diff series.
    const bottomPane = chart.addPane();

    const priceSeriesMap = new Map();
    const diffSeriesMap = new Map();

    // --- Plotting Logic ---
    async function plot() {
      // 1. Clear existing series
      for (const series of priceSeriesMap.values()) chart.removeSeries(series);
      for (const series of diffSeriesMap.values()) chart.removeSeries(series);
      priceSeriesMap.clear();
      diffSeriesMap.clear();

      // 2. Fetch Data
      const tickersRaw = document.getElementById('tickers-input').value.trim();
      if (!tickersRaw) return;
      const tickers = tickersRaw.split(/[\s,]+/).filter(Boolean).map(t => t.toUpperCase());
      const resp = await fetch(`http://localhost:5000/api/data?tickers=${encodeURIComponent(tickers.join(','))}`);
      if (!resp.ok) { alert('API error'); return; }
      const rawData = await resp.json();

      // 3. Normalize Data (Rebase to 100)
      const rebasedData = {};
      for (const ticker of tickers) {
        const tickerData = rawData[ticker]?.filter(p => p.value != null) || [];
        if (tickerData.length === 0) continue;
        const baseValue = tickerData[0].value;
        if (baseValue === 0) continue; // Avoid division by zero
        rebasedData[ticker] = tickerData.map(p => ({ time: p.time, value: (p.value / baseValue) * 100 }));
      }

      // 4. Calculate Average and Diff Series
      const timeMap = new Map();
      Object.values(rebasedData).forEach(series => {
        series.forEach(pt => {
          if (!timeMap.has(pt.time)) timeMap.set(pt.time, { sum: 0, count: 0 });
          const entry = timeMap.get(pt.time);
          entry.sum += pt.value;
          entry.count++;
        });
      });
      const avgData = Array.from(timeMap.entries()).map(([time, { sum, count }]) => ({ time, value: sum / count }));
      const avgLookup = new Map(avgData.map(p => [p.time, p.value]));

      const diffData = {};
      for (const ticker in rebasedData) {
        diffData[ticker] = rebasedData[ticker].map(p => {
          const avgVal = avgLookup.get(p.time);
          const diff = avgVal ? ((p.value / avgVal) - 1) * 100 : 0;
          return { time: p.time, value: diff };
        });
      }

      // 5. Plot Series on Correct Panes
      for (const ticker in rebasedData) {
        // Plot normalized price on top pane (pane 0)
        const priceSeries = chart.addSeries(LightweightCharts.LineSeries, { title: ticker, pane: 0 });
        priceSeries.setData(rebasedData[ticker]);
        priceSeriesMap.set(ticker, priceSeries);

        // Plot diff from average on bottom pane (pane 1)
        const diffSeries = chart.addSeries(LightweightCharts.LineSeries, { 
          title: `${ticker} Diff`, 
          pane: 1, 
          color: priceSeries.options().color, // Match color
          lineWidth: 1,
          lineStyle: LightweightCharts.LineStyle.Dotted,
        });
        diffSeries.setData(diffData[ticker]);
        diffSeriesMap.set(ticker, diffSeries);
      }

      chart.timeScale().fitContent();
    }

    document.getElementById('plot-btn').addEventListener('click', plot);
    plot(); // Initial plot on load
  </script>
</body>
</html>
